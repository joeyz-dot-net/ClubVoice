<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClubVoice SDK é›†æˆç¤ºä¾‹</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }

        .demo-content {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        /* ClubVoice Widget æ ·å¼ */
        .clubvoice-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(30, 30, 30, 0.95));
            border-radius: 15px;
            padding: 20px;
            color: white;
            font-family: 'Arial', sans-serif;
            z-index: 10000;
            min-width: 320px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease-in-out;
        }

        .clubvoice-widget.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .clubvoice-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #00ff88;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff4757;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #00ff88;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .clubvoice-controls {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .clubvoice-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .clubvoice-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .clubvoice-btn:hover::before {
            left: 100%;
        }
        
        .clubvoice-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .clubvoice-btn.active {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .clubvoice-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .clubvoice-btn:disabled:hover {
            box-shadow: none;
        }
        
        .volume-control {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .volume-label {
            font-size: 12px;
            color: #bbb;
            min-width: 35px;
        }
        
        .volume-slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #444;
            outline: none;
            -webkit-appearance: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #00ff88;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 255, 136, 0.3);
        }

        .volume-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #00ff88;
            cursor: pointer;
            border: none;
        }
        
        .status {
            font-size: 12px;
            color: #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status.connected {
            color: #00ff88;
        }
        
        .status.error {
            color: #ff6b6b;
        }

        .stats {
            font-size: 11px;
            color: #888;
        }

        /* éŸ³é¢‘å¯è§†åŒ– */
        .audio-visualizer {
            width: 100%;
            height: 30px;
            background: #222;
            border-radius: 4px;
            margin: 10px 0;
            position: relative;
            overflow: hidden;
        }

        .audio-bars {
            display: flex;
            height: 100%;
            align-items: end;
            gap: 1px;
            padding: 2px;
        }

        .audio-bar {
            background: linear-gradient(to top, #00ff88, #00aa55);
            width: 3px;
            transition: height 0.1s ease;
            border-radius: 1px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .clubvoice-widget {
                bottom: 10px;
                right: 10px;
                left: 10px;
                min-width: auto;
            }

            .clubvoice-controls {
                flex-direction: column;
                gap: 10px;
            }

            .volume-control {
                width: 100%;
            }
        }

        /* æµ‹è¯•å†…å®¹æ ·å¼ */
        .test-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        .btn:hover {
            background: #0056b3;
        }

        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            height: 200px;
            overflow-y: auto;
            font-size: 12px;
            margin: 10px 0;
        }

        .info-panel {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ ClubVoice SDK é›†æˆç¤ºä¾‹</h1>
        
        <div class="info-panel">
            <h3>ä½¿ç”¨è¯´æ˜</h3>
            <p><strong>è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„é›†æˆç¤ºä¾‹ï¼Œæ‚¨å¯ä»¥å°†å³ä¸‹è§’çš„å°ç»„ä»¶ä»£ç å¤åˆ¶åˆ°æ‚¨çš„ç‚¹æ’­ç½‘ç«™ d.joeyz.net æˆ– c.joeyz.net ä¸­ã€‚</strong></p>
            <p>ç‰¹æ€§ï¼š</p>
            <ul>
                <li>å®æ—¶éŸ³é¢‘æµæ¥æ”¶</li>
                <li>éŸ³é‡æ§åˆ¶</li>
                <li>è¿æ¥çŠ¶æ€ç›‘æ§</li>
                <li>éŸ³é¢‘å¯è§†åŒ–</li>
                <li>å“åº”å¼è®¾è®¡</li>
            </ul>
        </div>

        <div class="demo-content">
            <h2>æ¨¡æ‹Ÿç‚¹æ’­ç½‘ç«™å†…å®¹</h2>
            <p>è¿™é‡Œæ˜¯æ‚¨çš„ç‚¹æ’­ç½‘ç«™çš„ä¸»è¦å†…å®¹åŒºåŸŸã€‚ç”¨æˆ·å¯ä»¥æ­£å¸¸æµè§ˆå’Œä½¿ç”¨ç½‘ç«™åŠŸèƒ½ï¼ŒåŒæ—¶å³ä¸‹è§’çš„ ClubVoice å°ç»„ä»¶æä¾›è¯­éŸ³æˆ¿é—´æ”¶å¬åŠŸèƒ½ã€‚</p>
            
            <div class="test-section">
                <h3>æµ‹è¯•åŠŸèƒ½</h3>
                <button class="btn" onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
                <button class="btn" onclick="testAudio()">æµ‹è¯•éŸ³é¢‘</button>
                <button class="btn" onclick="showStats()">æ˜¾ç¤ºç»Ÿè®¡</button>
                <button class="btn" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
                
                <div class="log" id="testLog">
[ç³»ç»Ÿ] é¡µé¢åŠ è½½å®Œæˆï¼ŒClubVoice SDK åˆå§‹åŒ–ä¸­...
                </div>
            </div>
        </div>
    </div>

    <!-- ClubVoice Widget -->
    <div class="clubvoice-widget" id="clubvoice-widget">
        <div class="clubvoice-title">
            <span>ğŸ§</span>
            <span>æˆ¿é—´è¯­éŸ³</span>
            <div class="status-indicator" id="statusIndicator"></div>
        </div>
        
        <div class="clubvoice-controls">
            <button class="clubvoice-btn" id="listen-btn" disabled>è¿æ¥ä¸­...</button>
            <div class="volume-control">
                <span class="volume-label">éŸ³é‡</span>
                <input type="range" class="volume-slider" id="volume-slider" 
                       min="0" max="1" step="0.1" value="0.8" disabled>
            </div>
        </div>

        <!-- éŸ³é¢‘å¯è§†åŒ– -->
        <div class="audio-visualizer" id="audioVisualizer">
            <div class="audio-bars" id="audioBars">
                <!-- åŠ¨æ€ç”ŸæˆéŸ³é¢‘æ¡ -->
            </div>
        </div>
        
        <div class="status" id="status">
            <span>æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</span>
            <span class="stats" id="stats">0 packets</span>
        </div>
    </div>

    <!-- åŠ è½½ ClubVoice SDK -->
    <script src="/sdk/clubvoice.js"></script>
    <script>
        class VoiceWidget {
            constructor() {
                // ä½¿ç”¨å½“å‰é¡µé¢çš„åŸŸåä½œä¸ºæœåŠ¡å™¨åœ°å€
                this.serverUrl = window.location.origin;
                this.sdk = new ClubVoiceSDK(this.serverUrl);
                this.widget = document.getElementById('clubvoice-widget');
                this.listenBtn = document.getElementById('listen-btn');
                this.volumeSlider = document.getElementById('volume-slider');
                this.statusEl = document.getElementById('status');
                this.statusIndicator = document.getElementById('statusIndicator');
                this.statsEl = document.getElementById('stats');
                
                this.isVisible = false;
                this.audioVisualizerBars = [];
                
                this.init();
            }

            async init() {
                this.log('åˆå§‹åŒ– ClubVoice SDK...');
                this.createAudioVisualizer();
                
                // ç»‘å®š SDK äº‹ä»¶
                this.sdk.onConnected = (data) => {
                    this.log(`âœ… å·²è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œå®¢æˆ·ç«¯ID: ${data.client_id}`);
                    this.updateStatus('å·²è¿æ¥ï¼Œç‚¹å‡»å¼€å§‹æ”¶å¬', 'connected');
                    this.listenBtn.textContent = 'å¼€å§‹æ”¶å¬';
                    this.listenBtn.disabled = false;
                    this.volumeSlider.disabled = false;
                    this.statusIndicator.classList.add('connected');
                };

                this.sdk.onDisconnected = () => {
                    this.log('âŒ è¿æ¥å·²æ–­å¼€');
                    this.updateStatus('è¿æ¥æ–­å¼€ï¼Œæ­£åœ¨é‡è¿...', 'error');
                    this.listenBtn.textContent = 'é‡æ–°è¿æ¥';
                    this.listenBtn.disabled = false;
                    this.statusIndicator.classList.remove('connected');
                };

                this.sdk.onError = (error) => {
                    this.log(`âŒ é”™è¯¯: ${error.message}`);
                    this.updateStatus(`é”™è¯¯: ${error.message}`, 'error');
                };

                this.sdk.onListeningChanged = (listening) => {
                    this.listenBtn.textContent = listening ? 'åœæ­¢æ”¶å¬' : 'å¼€å§‹æ”¶å¬';
                    this.listenBtn.classList.toggle('active', listening);
                    this.updateStatus(listening ? 'ğŸ”Š æ­£åœ¨æ”¶å¬æˆ¿é—´è¯­éŸ³' : 'â¸ï¸ å·²åœæ­¢æ”¶å¬', 
                                    listening ? 'connected' : '');
                    this.log(listening ? 'ğŸµ å¼€å§‹æ”¶å¬æˆ¿é—´è¯­éŸ³' : 'â¹ï¸ åœæ­¢æ”¶å¬');
                };

                this.sdk.onAudioReceived = (info) => {
                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    this.statsEl.textContent = `${this.sdk.stats.packetsReceived} packets`;
                    
                    // æ›´æ–°éŸ³é¢‘å¯è§†åŒ–
                    this.updateAudioVisualizer(info.volume);
                    
                    // åŠ¨æ€æ›´æ–°çŠ¶æ€
                    if (info.volume > 8) {
                        this.statusEl.firstChild.textContent = `ğŸ”Š éŸ³é‡: ${info.volume.toFixed(0)}%`;
                    }
                };

                // ç»‘å®šæ§ä»¶äº‹ä»¶
                this.listenBtn.addEventListener('click', async () => {
                    try {
                        if (this.sdk.isListening) {
                            this.sdk.stopListening();
                        } else if (this.sdk.isConnected) {
                            await this.sdk.startListening();
                        } else {
                            // é‡æ–°è¿æ¥
                            await this.sdk.init();
                        }
                    } catch (error) {
                        this.log(`âŒ æ“ä½œå¤±è´¥: ${error.message}`);
                    }
                });

                this.volumeSlider.addEventListener('input', (e) => {
                    const volume = parseFloat(e.target.value);
                    this.sdk.setVolume(volume);
                    this.log(`ğŸ”Š éŸ³é‡è°ƒæ•´ä¸º: ${(volume * 100).toFixed(0)}%`);
                });

                try {
                    // åˆå§‹åŒ–è¿æ¥
                    await this.sdk.init();
                    this.showWidget();
                } catch (error) {
                    this.log(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
                    this.updateStatus('è¿æ¥å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•', 'error');
                    this.listenBtn.textContent = 'é‡è¯•è¿æ¥';
                    this.listenBtn.disabled = false;
                    this.showWidget();
                }
            }

            createAudioVisualizer() {
                const audioBars = document.getElementById('audioBars');
                for (let i = 0; i < 40; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'audio-bar';
                    bar.style.height = '2px';
                    audioBars.appendChild(bar);
                    this.audioVisualizerBars.push(bar);
                }
            }

            updateAudioVisualizer(volume) {
                const normalizedVolume = Math.min(volume / 50, 1); // æ ‡å‡†åŒ–éŸ³é‡
                const activeBars = Math.floor(normalizedVolume * this.audioVisualizerBars.length);
                
                this.audioVisualizerBars.forEach((bar, index) => {
                    if (index < activeBars) {
                        const height = Math.random() * 20 + 5; // éšæœºé«˜åº¦æ¨¡æ‹ŸéŸ³é¢‘æ³¢å½¢
                        bar.style.height = `${height}px`;
                    } else {
                        bar.style.height = '2px';
                    }
                });
            }

            showWidget() {
                if (!this.isVisible) {
                    setTimeout(() => {
                        this.widget.classList.add('show');
                        this.isVisible = true;
                    }, 1000);
                }
            }

            updateStatus(text, className = '') {
                this.statusEl.firstChild.textContent = text;
                this.statusEl.className = `status ${className}`;
            }

            log(message) {
                const timestamp = new Date().toLocaleTimeString();
                const logEl = document.getElementById('testLog');
                logEl.innerHTML += `\n[${timestamp}] ${message}`;
                logEl.scrollTop = logEl.scrollHeight;
                console.log(`[ClubVoice] ${message}`);
            }

            getSDK() {
                return this.sdk;
            }
        }

        // æµ‹è¯•åŠŸèƒ½
        let voiceWidget;

        function testConnection() {
            const status = voiceWidget.getSDK().getStatus();
            voiceWidget.log(`è¿æ¥çŠ¶æ€: ${JSON.stringify(status, null, 2)}`);
        }

        function testAudio() {
            const sdk = voiceWidget.getSDK();
            if (sdk.isConnected && !sdk.isListening) {
                sdk.startListening().then(() => {
                    voiceWidget.log('ğŸµ éŸ³é¢‘æµ‹è¯•ï¼šå¼€å§‹æ”¶å¬');
                }).catch(error => {
                    voiceWidget.log(`âŒ éŸ³é¢‘æµ‹è¯•å¤±è´¥: ${error.message}`);
                });
            } else if (sdk.isListening) {
                voiceWidget.log('ğŸµ éŸ³é¢‘æµ‹è¯•ï¼šå½“å‰æ­£åœ¨æ”¶å¬ä¸­');
            } else {
                voiceWidget.log('âŒ éŸ³é¢‘æµ‹è¯•ï¼šè¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨');
            }
        }

        function showStats() {
            const stats = voiceWidget.getSDK().stats;
            voiceWidget.log(`ç»Ÿè®¡ä¿¡æ¯:
- æ¥æ”¶åŒ…æ•°: ${stats.packetsReceived}
- æ¥æ”¶å­—èŠ‚: ${stats.bytesReceived}
- è¿æ¥æ—¶é—´: ${stats.connectionTime ? stats.connectionTime.toLocaleString() : 'æœªè¿æ¥'}`);
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '[ç³»ç»Ÿ] æ—¥å¿—å·²æ¸…ç©º';
        }

        // é¡µé¢åŠ è½½ååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            voiceWidget = new VoiceWidget();
            window.voiceWidget = voiceWidget; // æš´éœ²åˆ°å…¨å±€ç”¨äºè°ƒè¯•
        });

        // é¡µé¢å…³é—­æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (voiceWidget && voiceWidget.getSDK()) {
                voiceWidget.getSDK().disconnect();
            }
        });
    </script>
</body>
</html>