"""
诊断浏览器接收 Clubdeck 音频问题
"""

print("=" * 70)
print("浏览器音频接收诊断")
print("=" * 70)

print("""
问题：浏览器听不到 Clubdeck 房间声音

已确认工作的部分：
  ✅ CABLE-A 虚拟线缆正常
  ✅ 设备 36 可以读取 Clubdeck 音频
  ✅ 设备 28 可以写入浏览器麦克风

待检查的部分：
  ❓ ClubVoice 程序是否正在运行
  ❓ WebSocket 连接是否建立
  ❓ 浏览器端是否点击"开始接收音频"
  ❓ 音频数据是否正确传输

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
检查清单
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1️⃣ ClubVoice 服务器是否运行？
   
   检查方法：
   - 终端中是否看到 "Server running at http://0.0.0.0:5000"
   - 访问 http://localhost:5000 是否能打开页面
   
   如果没有运行，执行：
     python run.py

2️⃣ 浏览器是否连接到服务器？
   
   检查方法：
   - 打开 http://localhost:5000
   - 查看页面上的连接状态指示器
   - 应该显示 "已连接" 或绿色圆点
   
   如果未连接：
   - 刷新页面 (F5)
   - 检查浏览器控制台 (F12) 是否有错误

3️⃣ 浏览器是否启用了音频接收？
   
   重要！浏览器需要用户交互才能播放音频：
   - 页面上应该有 "🔊 开始接收音频" 按钮
   - 必须点击这个按钮才能听到声音
   - 点击后按钮应该变成 "✓ 已开始接收"
   
   如果没有这个按钮：
   - 访问 http://localhost:5000/debug.html
   - 点击 "🔊 开始接收音频" 按钮

4️⃣ Clubdeck 是否有音频输出？
   
   验证方法：
   在另一个终端运行：
     echo "36" | python tools/simple_volume_monitor.py
   
   - 在 Clubdeck 房间大声说话
   - 监控应显示 40-80% 音量
   - 如果音量很低 (<10%)，需要调高 Clubdeck 音量

5️⃣ 检查音频数据传输
   
   打开浏览器调试页面：
     http://localhost:5000/debug.html
   
   观察：
   - "接收音量" 波形是否有变化
   - "接收包数" 是否在增加
   - "连接状态" 是否为 "已连接"
   
   如果接收包数不增加：
   - ClubVoice 程序可能没有正确读取音频
   - 检查 Python 终端是否有错误信息

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
快速测试步骤
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

终端 1: 启动 ClubVoice
  python run.py

终端 2: 监控 Clubdeck 音频
  echo "36" | python tools/simple_volume_monitor.py

浏览器:
  1. 打开 http://localhost:5000/debug.html
  2. 点击 "🔊 开始接收音频" 按钮
  3. 观察 "接收音量" 波形

Clubdeck:
  - 在房间中大声说话或播放音乐

如果配置正确，应该：
  ✅ 终端 2 显示 40-80% 音量
  ✅ 浏览器 debug.html 显示接收音量波动
  ✅ 浏览器能听到声音

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
常见问题
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

问题 1: "接收包数" 不增加
原因: ClubVoice 没有从设备 36 读取音频
解决: 
  - 检查 config.ini 中 clubdeck_input_device_id = 36
  - 重启 python run.py
  - 查看 Python 终端错误信息

问题 2: "接收包数" 增加但听不到声音
原因: 浏览器没有启用音频播放
解决: 
  - 点击 "🔊 开始接收音频" 按钮
  - 检查浏览器音量是否静音
  - 检查系统音量是否静音

问题 3: 声音断断续续
原因: 网络延迟或缓冲区问题
解决:
  - 如果是本地访问，应该很流畅
  - 检查 CPU 占用是否过高
  - 检查其他程序是否占用音频设备

问题 4: 音量很小
原因: Clubdeck 输出音量太低
解决:
  - 调高 Clubdeck 主音量
  - 调高 Windows 中 CABLE-A Input 音量到 100%
  - 调高浏览器系统音量

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
""")

print("=" * 70)
print("请按照上述步骤逐一检查")
print("=" * 70)
print()

import subprocess
import time

# 检查服务器是否运行
print("正在检查 ClubVoice 服务器状态...")
try:
    import requests
    response = requests.get('http://localhost:5000/status', timeout=2)
    if response.status_code == 200:
        print("✅ ClubVoice 服务器正在运行")
        print(f"   访问: http://localhost:5000")
        print(f"   调试: http://localhost:5000/debug.html")
    else:
        print("❌ 服务器响应异常")
except:
    print("❌ ClubVoice 服务器未运行")
    print("   请在另一个终端运行: python run.py")

print()
