"""
检查音频数据传输问题
"""

print("=" * 70)
print("音频数据传输诊断")
print("=" * 70)

print("""
状态：
  ✅ 浏览器显示已连接
  ❌ 浏览器没有接收到音频

可能原因：
  1. Python 没有从设备 36 读取音频
  2. Clubdeck 没有输出音频到 CABLE-A Input
  3. 音频数据没有通过 WebSocket 发送

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
立即检查步骤
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

步骤 1: 检查浏览器调试页面
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

在 http://localhost:5000/debug.html 查看：

  问题：接收包数是否在增加？
  
  如果 "接收包数" = 0 或不增加：
    ❌ Python 没有发送音频数据
    → 继续步骤 2
  
  如果 "接收包数" 持续增加（例如每秒增加 90+）：
    ✅ 数据正在传输
    ❌ 但浏览器没有播放
    → 跳到步骤 4

步骤 2: 检查 Python 终端输出
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

查看运行 "python run.py" 的终端：

  正常情况应该看到：
    ✅ "使用配置文件中的3-Cable架构设备"
    ✅ "CABLE-B (MPV音乐输入) 设备 35"
    ✅ "CABLE-A (Clubdeck→浏览器) 设备 36"  ← 这个很关键！
    ✅ "CABLE-A (浏览器→Clubdeck) 设备 28"
    ✅ "Server running at http://0.0.0.0:5000"
  
  如果看到错误信息：
    ❌ "Error starting stream"
    ❌ "Device unavailable"
    → 设备被占用或配置错误
    → 重启程序: Ctrl+C 然后 python run.py

步骤 3: 验证 Clubdeck 音频输出
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

在新终端运行：
  echo "36" | python tools/simple_volume_monitor.py

然后在 Clubdeck 房间大声说话：

  期望结果：
    ✅ 音量显示 40-80%
  
  实际结果如果：
    ❌ 音量 = 0% 或很小 (<5%)
    → Clubdeck 没有输出到 CABLE-A Input
    → 检查 Clubdeck 扬声器设备设置

步骤 4: 检查浏览器音频状态
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

如果接收包数增加但听不到声音：

  1. 检查是否点击了 "🔊 开始接收音频" 按钮
     - 按钮应该显示 "✓ 已开始接收"
     - 如果显示 "🔊 开始接收音频"，请点击它
  
  2. 检查浏览器是否静音
     - 查看浏览器标签页是否有 🔇 图标
     - 右键标签页 → 取消静音
  
  3. 检查系统音量
     - 任务栏音量图标
     - 调高到 50% 以上
  
  4. 按 F12 打开浏览器控制台
     - 查看是否有错误信息
     - 特别是 "AudioContext" 相关错误

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
快速诊断命令
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

在 PowerShell 中运行（检查设备 36 是否有音频）：
""")

print('python -c "import sounddevice as sd; import numpy as np; import time; stream = sd.InputStream(device=36, samplerate=48000, channels=2, dtype=\'int16\', blocksize=512); stream.start(); time.sleep(1); indata, _ = stream.read(512); stream.stop(); rms = np.sqrt(np.mean(indata.astype(np.float32) ** 2 / (32768.0 ** 2))); volume = min(100.0, rms * 100.0 * 10.0); print(f\'设备 36 当前音量: {volume:.1f}%\'); print(\'需要 >10% 才能听到声音\' if volume < 10 else \'音量正常！\')"')

print("""
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
最可能的问题
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

根据经验，80% 的情况是以下三个问题之一：

❌ 问题 1: Clubdeck 没有音频输出
   症状: 设备 36 音量 = 0%
   解决: 
   - 在 Clubdeck 房间中大声说话或播放音乐
   - 检查 Clubdeck 扬声器设备 = CABLE-A Input
   - 检查 Clubdeck 主音量是否太低

❌ 问题 2: 浏览器没有启用音频
   症状: 接收包数增加但听不到
   解决:
   - 点击 "🔊 开始接收音频" 按钮
   - 刷新页面重新点击

❌ 问题 3: Python 程序配置错误
   症状: Python 终端显示错误
   解决:
   - 检查 config.ini 中 clubdeck_input_device_id = 36
   - 重启: Ctrl+C 然后 python run.py
""")

print("=" * 70)
print("请告诉我：")
print("=" * 70)
print("""
1. debug.html 页面上的"接收包数"是多少？是否在增加？
2. Python 终端是否显示错误信息？
3. 设备 36 的音量监控显示多少？

有了这些信息，我可以精确定位问题！
""")
